<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>SQL学习笔记</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="Li,Gongfu">

    <!-- Le styles -->
    <link rel="stylesheet" href="/theme/css/bootstrap.min.css" type="text/css" />
    <style type="text/css">
      body {
        padding-top: 60px;
        padding-bottom: 40px;
      }
      .sidebar-nav {
        padding: 9px 0;
      }
      .tag-1 {
        font-size: 13pt;
      }
      .tag-2 {
        font-size: 10pt;
      }
      .tag-2 {
        font-size: 8pt;
      }
      .tag-4 {
        font-size: 6pt;
     }
    </style>
    <link href="/theme/css/bootstrap-responsive.min.css" rel="stylesheet">
        <link href="/theme/css/font-awesome.css" rel="stylesheet">

    <link href="/theme/css/pygments.css" rel="stylesheet">

    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="//html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le fav and touch icons -->
    <link rel="shortcut icon" href="/theme/images/favicon.ico">
    <link rel="apple-touch-icon" href="/theme/images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/theme/images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/theme/images/apple-touch-icon-114x114.png">

    <link href="/" type="application/atom+xml" rel="alternate" title="晓新's Blog ATOM Feed" />

  </head>

  <body>

    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container-fluid">
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <a class="brand" href="/index.html">晓新's Blog </a>
          <div class="nav-collapse">
            <ul class="nav">
                          <li class="divider-vertical"></li>
                  <li >
                    <a href="/category/fen-bu-shi.html">
						<i class="icon-folder-open icon-large"></i>分布式
					</a>
                  </li>
                  <li >
                    <a href="/category/java.html">
						<i class="icon-folder-open icon-large"></i>JAVA
					</a>
                  </li>
                  <li >
                    <a href="/category/machine-learning.html">
						<i class="icon-folder-open icon-large"></i>Machine Learning
					</a>
                  </li>
                  <li >
                    <a href="/category/perl.html">
						<i class="icon-folder-open icon-large"></i>Perl
					</a>
                  </li>
                  <li >
                    <a href="/category/python.html">
						<i class="icon-folder-open icon-large"></i>Python
					</a>
                  </li>
                  <li >
                    <a href="/category/scala.html">
						<i class="icon-folder-open icon-large"></i>Scala
					</a>
                  </li>
                  <li class="active">
                    <a href="/category/shu-ju-ku.html">
						<i class="icon-folder-open icon-large"></i>数据库
					</a>
                  </li>
                  <li >
                    <a href="/category/technology.html">
						<i class="icon-folder-open icon-large"></i>Technology
					</a>
                  </li>

                          <ul class="nav pull-right">
                                <li><a href="/archives.html"><i class="icon-th-list"></i>Archives</a></li>
                          </ul>

            </ul>
            <!--<p class="navbar-text pull-right">Logged in as <a href="#">username</a></p>-->
          </div><!--/.nav-collapse -->
        </div>
      </div>
    </div>

    <div class="container-fluid">
      <div class="row">
        <div class="span9" id="content">
<section id="content">
        <article>
                <header>
                        <h1>
                                <a href=""
                                        rel="bookmark"
                                        title="Permalink to SQL学习笔记">
                                        SQL学习笔记
                                </a>
                        </h1>
                </header>
                <div class="entry-content">
                <div class="well">
<footer class="post-info">
<span class="label">Date</span>
<abbr class="published" title="2014-05-22T16:26:00">
        <i class="icon-calendar"></i>四 22 五月 2014
</abbr>
<span class="label">By</span>
<a href="/author/ligongfu.html"><i class="icon-user"></i>Li,Gongfu</a>
<span class="label">Category</span>
<a href="/category/shu-ju-ku.html"><i class="icon-folder-open"></i>数据库</a>.


<span class="label">Tags</span>
	<a href="/tag/sql.html"><i class="icon-tag"></i>SQL</a>
</footer><!-- /.post-info -->                </div>
                <p>最近因为参加<a href="http://102.alibaba.com/competition/addDiscovery/index.htm">阿里巴巴大叔据竞赛</a>,还算顺利的进入了第二轮，跟第一轮不同，官方给出的数据量大增，需要用到的技术也从单纯的机器学习算法扩展到 <strong>hadoop</strong> , <strong>sql</strong>等技术的使用，只好把曾经学过的数据库捡一捡，整理了一下我在竞赛中常用到的一些命令，相信这些命令对于常见的查询任务已经足够了。 </p>
<h2>首先明确几个概念：</h2>
<ul>
<li>关系模式
下表是一个department关系，列表示属性，每一行是一个元组，也叫关系实例。
dept_name      | building    |budget
---------   | -----    |------
Biology    | Watson |90000
Comp.Sci       | Taylor |100000
History        | Painter    |800000</li>
</ul>
<p>department关系模式可以表示为：</p>
<div class="highlight"><pre><span class="n">department</span><span class="p">(</span><span class="n">dept_name</span><span class="p">,</span><span class="n">building</span><span class="p">,</span><span class="n">budget</span><span class="p">)</span>
</pre></div>


<ul>
<li>
<p>主码 
一个或多个属性的集合，使得在关系中能唯一的标识一个元组。并且它的任意真子集都不能唯一的标识一个元组。<strong>码</strong>代表的是整个关系的性质，而不是单个元组的性质。</p>
</li>
<li>
<p>参照关系
一个关系模式r1可能在它的属性中包括另外一个关系r2的主码，这个属性在r1上称为参照r2的外码，关系r1成为外码依赖的参照关系，r2成为外码的被参照关系。例如有instructor关系：</p>
</li>
</ul>
<table>
<thead>
<tr>
<th>ID</th>
<th>name</th>
<th>dept_name</th>
<th>salary</th>
</tr>
</thead>
<tbody>
<tr>
<td>10100</td>
<td>Wu</td>
<td>History</td>
<td>40000</td>
</tr>
<tr>
<td>10002</td>
<td>Taylor</td>
<td>Comp.Sci</td>
<td>100000</td>
</tr>
<tr>
<td>12232</td>
<td>Peter</td>
<td>History</td>
<td>800000</td>
</tr>
<tr>
<td>instructor的dept_name属性在instructor上是外码，它参照department，因为dept_name是department的主码。参照关系有一些特殊的性质，从instructor关系中任取一个元组，在department关系中肯定存在一个元组使得在dept_name上的取值相同。</td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<ul>
<li>笛卡儿乘积
从两个输入关系中输出所有元组对，不论他们在共同属性上的取值时候相同。</li>
<li>自然连接
从两个输入关系中输出这样的元组对：他们在具有相同名字的所有属性上取值相同。</li>
</ul>
<p>显然自然连接是笛卡儿连接的子集。</p>
<h2>sql的基本数据类型</h2>
<ul>
<li>char（n）：固定长度的字符串，n由用户指定。</li>
<li>varchar（n）：可变长的字符串，最大长度为n。</li>
<li>int</li>
<li>numeric（p，d）：p为位数，d为小数点右边的位数。如numeric（3,2）可以存储4.44</li>
<li>float</li>
<li>double precision</li>
</ul>
<h2>sql的常用命令</h2>
<h3>创建/更新关系</h3>
<ul>
<li>创建关系</li>
</ul>
<div class="highlight"><pre><span class="n">creat</span> <span class="n">table</span>

    <span class="n">create</span> <span class="n">table</span> <span class="nf">department</span>
    <span class="p">(</span><span class="n">dept_name</span>  <span class="n">varchar</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span>
    <span class="n">building</span> <span class="n">varchar</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span>
    <span class="n">budget</span> <span class="n">numeric</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span>
    <span class="n">primary</span> <span class="n">key</span> <span class="p">(</span><span class="n">dept_name</span><span class="p">));</span>
</pre></div>


<ul>
<li>插入元组</li>
</ul>
<div class="highlight"><pre><span class="n">insert</span> <span class="n">into</span>

    <span class="n">insert</span> <span class="n">into</span> <span class="n">instructor</span> 
    <span class="nf">values</span><span class="p">(</span><span class="mi">10211</span><span class="p">,</span><span class="err">&#39;</span><span class="n">smith</span><span class="sc">&#39;,&#39;</span><span class="n">Boilogy</span><span class="err">&#39;</span><span class="p">,</span><span class="mi">100000</span><span class="p">);</span>
</pre></div>


<ul>
<li>删除所有元组</li>
</ul>
<div class="highlight"><pre><span class="n">delete</span> <span class="n">from</span>

    <span class="n">delete</span> <span class="n">from</span> <span class="n">student</span><span class="p">;</span> <span class="err">删除所有元祖，但保留关系</span>
</pre></div>


<ul>
<li>删除关系</li>
</ul>
<div class="highlight"><pre><span class="n">drop</span> <span class="n">table</span>

    <span class="n">drop</span> <span class="n">table</span> <span class="n">r</span><span class="p">;</span><span class="err">删除关系</span><span class="n">r</span>
</pre></div>


<ul>
<li>向关系中新增属性</li>
</ul>
<div class="highlight"><pre><span class="n">alert</span> <span class="n">table</span>

    <span class="n">alert</span> <span class="n">table</span> <span class="n">r</span> <span class="n">add</span> <span class="n">A</span> <span class="n">D</span> <span class="err">向关系</span><span class="n">r</span><span class="err">中添加属性</span><span class="n">A</span><span class="err">，其域是</span><span class="n">D</span><span class="err">。</span>
</pre></div>


<h3>查询语句：</h3>
<h4>select-from-where</h4>
<p>查询语句返回关系作为结果。每个子句的作用是：</p>
<ul>
<li>select 子句用于列出查询结果中所需要的属性。</li>
<li>from 子句是一个查询求值中需要访问的关系列表。</li>
<li>where子句是一个作用在from子句中关系的属性上的谓词。</li>
</ul>
<p>于是，一个SQL查询的含义可以这么理解：</p>
<ul>
<li>为from子句中列出的关系产生笛卡儿积</li>
<li>在笛卡儿积的结果上应用where子句中指定的谓词。</li>
<li>在上面2步的结果中的每个元组，输出select子句中指定的属性，或表达式的结果。</li>
</ul>
<div class="highlight"><pre><span class="err">单关系查询</span>
<span class="n">select</span> <span class="n">dept_name</span>
<span class="n">from</span> <span class="n">instructor</span><span class="p">;</span>

<span class="n">select</span> <span class="n">distinct</span> <span class="n">dept_name</span>   <span class="n">distinct</span><span class="err">是去重复。</span>
<span class="n">from</span> <span class="n">instructor</span><span class="p">;</span>
</pre></div>


<div class="highlight"><pre><span class="n">select</span> <span class="n">name</span>
<span class="n">from</span> <span class="n">instructor</span>
<span class="n">where</span> <span class="n">dept_name</span><span class="o">=</span><span class="err">&#39;</span><span class="n">Comp</span><span class="p">.</span><span class="n">Sci</span><span class="p">.</span><span class="err">&#39;</span> <span class="n">and</span> <span class="n">salary</span><span class="o">&gt;</span><span class="mi">70000</span><span class="p">;</span>
</pre></div>


<div class="highlight"><pre><span class="err">多关系查询</span>
<span class="n">select</span> <span class="n">name</span> <span class="p">,</span><span class="n">instructor</span><span class="p">.</span><span class="n">dept_name</span><span class="p">,</span><span class="n">building</span>
<span class="n">from</span> <span class="n">instructor</span><span class="p">,</span><span class="n">department</span>
<span class="n">where</span> <span class="n">instrcutor</span><span class="p">.</span><span class="n">dept_name</span><span class="o">=</span><span class="n">department</span><span class="p">.</span><span class="n">dept_name</span>
</pre></div>


<h4>自然连接</h4>
<div class="highlight"><pre><span class="n">natrual</span> <span class="n">join</span>

<span class="n">select</span> <span class="n">name</span> <span class="p">,</span><span class="n">course_id</span>
<span class="n">from</span> <span class="n">instructor</span> <span class="n">natrual</span> <span class="n">join</span> <span class="n">teaches</span><span class="p">;</span>

<span class="n">select</span> <span class="n">name</span> <span class="p">,</span><span class="n">course_id</span>
<span class="n">from</span> <span class="n">instructor</span><span class="p">,</span><span class="n">teaches</span>
<span class="n">where</span> <span class="n">instrcutor</span><span class="p">.</span><span class="n">ID</span><span class="o">=</span><span class="n">department</span><span class="p">.</span><span class="n">ID</span>
</pre></div>


<h4>as 关键字</h4>
<p>as关键字可以用来更名，适用于关系名字或属性名字。</p>
<div class="highlight"><pre><span class="n">select</span> <span class="n">distinct</span> <span class="n">T</span><span class="p">.</span><span class="n">name</span>
<span class="n">from</span> <span class="n">instructor</span> <span class="n">as</span> <span class="n">T</span><span class="p">,</span><span class="n">instructor</span> <span class="n">as</span> <span class="n">S</span>
<span class="n">where</span> <span class="n">T</span><span class="p">.</span><span class="n">salary</span><span class="o">&gt;</span><span class="n">S</span><span class="p">.</span><span class="n">salary</span> <span class="n">and</span> <span class="n">S</span><span class="p">.</span><span class="n">dept_name</span><span class="o">=</span><span class="err">&#39;</span><span class="n">Biology</span><span class="err">&#39;</span><span class="p">;</span>
</pre></div>


<h4>like+escape关键字</h4>
<p>like关键字提供模式匹配的方法，sql是大小写敏感的。sql提供两个特殊字符来描述模式：</p>
<ul>
<li>%:匹配任意子串，如'intro%'匹配任意以intro开头的字符串，'%intro%'匹配任意包含intro的字符串。</li>
<li>_:匹配任意一个字符，如'___'匹配只含三个字符的子字符串。</li>
</ul>
<div class="highlight"><pre><span class="n">like</span><span class="err">关键字</span>
<span class="n">select</span> <span class="n">dept_name</span>
<span class="n">from</span> <span class="n">department</span>
<span class="n">where</span> <span class="n">building</span> <span class="n">like</span> <span class="err">&#39;</span><span class="o">%</span><span class="n">Waston</span><span class="err">&#39;</span><span class="p">;</span> 

<span class="n">like</span> <span class="err">&#39;</span><span class="n">ab</span><span class="err">\</span><span class="o">%</span><span class="n">cd</span><span class="o">%</span><span class="err">&#39;</span> <span class="n">escape</span> <span class="err">&#39;\&#39;</span>      <span class="n">escape</span><span class="err">定义转义字符串模式</span><span class="p">,</span><span class="err">使第一个</span><span class="o">%</span><span class="err">变成普通字符</span>
</pre></div>


<h4>order by关键字</h4>
<p>排列元组的显示次序。desc表示降序，asc表示升序。</p>
<div class="highlight"><pre><span class="n">select</span> <span class="n">name</span> 
<span class="n">from</span> <span class="n">instructor</span>
<span class="n">where</span> <span class="n">dept_name</span><span class="o">=</span><span class="err">&#39;</span><span class="n">Physics</span><span class="err">&#39;</span>
<span class="n">order</span> <span class="n">by</span> <span class="n">name</span> <span class="n">desc</span><span class="p">;</span>
</pre></div>


<h4>between ,and关键字</h4>
<div class="highlight"><pre><span class="n">select</span> <span class="n">name</span>
<span class="n">from</span> <span class="n">instructor</span>
<span class="n">where</span> <span class="n">salary</span> <span class="n">between</span> <span class="mi">9000</span> <span class="n">and</span> <span class="mi">10000</span><span class="p">;</span>
</pre></div>


<h4>union 并运算</h4>
<div class="highlight"><pre><span class="p">(</span><span class="n">select</span> <span class="n">course_id</span>
<span class="n">from</span> <span class="n">section</span>
<span class="n">where</span> <span class="n">semester</span><span class="o">=</span><span class="err">&#39;</span><span class="n">Fall</span><span class="err">&#39;</span> <span class="n">and</span> <span class="n">year</span><span class="o">=</span><span class="mi">2009</span><span class="p">)</span>
<span class="k">union</span>
<span class="p">(</span><span class="n">select</span> <span class="n">course_id</span>
<span class="n">from</span> <span class="n">section</span>
<span class="n">where</span> <span class="n">semester</span><span class="o">=</span><span class="err">&#39;</span><span class="n">Spring</span><span class="err">&#39;</span> <span class="n">and</span> <span class="n">year</span><span class="o">=</span><span class="mi">2010</span><span class="p">);</span>
</pre></div>


<p>union将自动去重复，如果想保留重复，使用union all。</p>
<h4>intersect 交运算</h4>
<div class="highlight"><pre><span class="p">(</span><span class="n">select</span> <span class="n">course_id</span>
<span class="n">from</span> <span class="n">section</span>
<span class="n">where</span> <span class="n">semester</span><span class="o">=</span><span class="err">&#39;</span><span class="n">Fall</span><span class="err">&#39;</span> <span class="n">and</span> <span class="n">year</span><span class="o">=</span><span class="mi">2009</span><span class="p">)</span>
<span class="n">intersect</span>
<span class="p">(</span><span class="n">select</span> <span class="n">course_id</span>
<span class="n">from</span> <span class="n">section</span>
<span class="n">where</span> <span class="n">semester</span><span class="o">=</span><span class="err">&#39;</span><span class="n">Spring</span><span class="err">&#39;</span> <span class="n">and</span> <span class="n">year</span><span class="o">=</span><span class="mi">2010</span><span class="p">);</span>
</pre></div>


<h4>except 差运算</h4>
<div class="highlight"><pre><span class="p">(</span><span class="n">select</span> <span class="n">course_id</span>
<span class="n">from</span> <span class="n">section</span>
<span class="n">where</span> <span class="n">semester</span><span class="o">=</span><span class="err">&#39;</span><span class="n">Fall</span><span class="err">&#39;</span> <span class="n">and</span> <span class="n">year</span><span class="o">=</span><span class="mi">2009</span><span class="p">)</span>
<span class="n">except</span>
<span class="p">(</span><span class="n">select</span> <span class="n">course_id</span>
<span class="n">from</span> <span class="n">section</span>
<span class="n">where</span> <span class="n">semester</span><span class="o">=</span><span class="err">&#39;</span><span class="n">Spring</span><span class="err">&#39;</span> <span class="n">and</span> <span class="n">year</span><span class="o">=</span><span class="mi">2010</span><span class="p">);</span>
</pre></div>


<h4>null 空值</h4>
<p>sql把涉及null的比较运算视为unknown。</p>
<div class="highlight"><pre><span class="n">select</span> <span class="n">name</span>
<span class="n">from</span> <span class="n">instructor</span>
<span class="n">where</span> <span class="n">salary</span> <span class="n">is</span> <span class="n">null</span>
</pre></div>


<h4>聚集函数</h4>
<ul>
<li>sum 求和</li>
</ul>
<div class="highlight"><pre><span class="n">select</span> <span class="n">sum</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span>
<span class="n">from</span> <span class="n">instructor</span><span class="p">;</span>
</pre></div>


<ul>
<li>avg 平均值 </li>
</ul>
<div class="highlight"><pre><span class="n">select</span> <span class="n">avg</span> <span class="p">(</span><span class="n">salary</span><span class="p">)</span>
<span class="n">from</span> <span class="n">instructor</span> 
<span class="n">where</span> <span class="n">dept_name</span><span class="o">=</span><span class="err">&#39;</span><span class="n">Comp</span><span class="p">.</span><span class="n">Sci</span><span class="err">&#39;</span><span class="p">;</span>
</pre></div>


<ul>
<li>count 统计次数
经常用count计算一个关系中元组的个数。也经常与distinct结合使用。</li>
</ul>
<div class="highlight"><pre><span class="n">select</span> <span class="n">count</span> <span class="p">(</span><span class="o">*</span><span class="p">)</span>
<span class="n">from</span> <span class="n">course</span><span class="p">;</span>

<span class="n">select</span> <span class="n">count</span><span class="p">(</span><span class="n">distinct</span> <span class="n">ID</span><span class="p">)</span>
<span class="n">from</span> <span class="n">teaches</span><span class="p">;</span>
</pre></div>


<ul>
<li>group by 
用一个或多个属性来构造分组，在group子句中的所有属性上取值相同的元组将被分到同一个组里。</li>
</ul>
<div class="highlight"><pre><span class="n">select</span> <span class="n">dept_name</span><span class="p">,</span><span class="n">avg</span> <span class="p">(</span><span class="n">salary</span><span class="p">)</span> <span class="n">as</span> <span class="n">avg_salary</span>
<span class="n">from</span> <span class="n">instructor</span>
<span class="n">group</span> <span class="n">by</span> <span class="n">dept_name</span><span class="p">;</span>
</pre></div>


<ul>
<li>having 子句
having子句步针对单个元组，而是针对group by子句构成的分组。having子句中的谓词在形成分组之后才会起作用。
having ,where子句的区别：<blockquote>
<p>having 字句限定分组。
where字句限定所有元祖。</p>
</blockquote>
</li>
</ul>
<div class="highlight"><pre><span class="n">select</span> <span class="n">dept_name</span><span class="p">,</span><span class="n">avg</span> <span class="p">(</span><span class="n">salary</span><span class="p">)</span> <span class="n">as</span> <span class="n">avg_salary</span>
<span class="n">from</span> <span class="n">instructor</span>
<span class="n">group</span> <span class="n">by</span> <span class="n">dept_name</span>
<span class="n">having</span> <span class="n">avg</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">40000</span><span class="p">;</span>
</pre></div>


<p>包含聚集，group by， having子句的查询可通过下述操作序列来定义：</p>
<blockquote>
<ol>
<li>先根据from子句计算一个关系。</li>
<li>如果有where子句，where子句的谓词应用到from的结果关系上。</li>
<li>如果有group by子句，满足where谓词的元组通过group by子句形成分组。如果没有group by，则所有满足where的元祖为同一个分组。</li>
<li>如果有having子句，它将应用到每个分组上，不满足having子句谓词的分组将被抛弃.
5.select子句利用剩下的分组产生出查询结果中的元组,即在每个分组上应用聚集函数，avg，count，max，min等,得到单个结果的元祖。</li>
</ol>
</blockquote>
<p><strong>例子：</strong></p>
<div class="highlight"><pre><span class="n">select</span> <span class="n">course_id</span><span class="p">,</span><span class="n">semester</span><span class="p">,</span><span class="n">year</span><span class="p">,</span><span class="n">sec_id</span><span class="p">,</span><span class="n">avg</span><span class="p">(</span><span class="n">total_score</span><span class="p">)</span>
<span class="n">from</span> <span class="n">takes</span> <span class="n">natrual</span> <span class="n">join</span> <span class="n">student</span>
<span class="n">where</span> <span class="n">year</span> <span class="o">=</span><span class="mi">2009</span>
<span class="n">group</span> <span class="n">by</span> <span class="n">course_id</span><span class="p">,</span><span class="n">semester</span><span class="p">,</span><span class="n">year</span><span class="p">,</span><span class="n">sec_id</span>
<span class="n">having</span> <span class="n">count</span><span class="p">(</span><span class="n">ID</span><span class="p">)</span><span class="o">&gt;=</span><span class="mi">2</span><span class="p">;</span>
<span class="c1">//对于在2009年讲授的每个课程,如果该课程有至少两个学生选课,找出选修该课程的所有学生的总学分的平均值.</span>
</pre></div>


<h4>嵌套子查询</h4>
<p>嵌套查询的依据是:任何select-from-where表达式返回的结果都是关系,因而可以被插入到另一个select-from-where中任何关系可以出现的位置.</p>
<ul>
<li>where子句嵌套
连接词<code>in</code>测试元组是否是集合中的成员,集合是由select子句产生的一组值构成的.对应有<code>not in</code>.</li>
</ul>
<div class="highlight"><pre><span class="err">例</span><span class="mi">1</span> <span class="err">在单属性关系中测试成员资格</span><span class="p">.</span>
<span class="n">select</span> <span class="n">course_id</span>
<span class="n">from</span> <span class="n">section</span>
<span class="n">where</span> <span class="n">semester</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">Fall</span><span class="err">&#39;</span> <span class="n">and</span> <span class="n">year</span><span class="o">=</span><span class="mi">2009</span> <span class="n">and</span> 
    <span class="n">course_id</span> <span class="n">in</span> <span class="p">(</span><span class="n">select</span> <span class="n">course_id</span>
    <span class="n">from</span> <span class="n">section</span>
    <span class="n">where</span> <span class="n">semester</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">Fall</span><span class="err">&#39;</span> <span class="n">and</span> <span class="n">year</span><span class="o">=</span><span class="mi">2010</span> <span class="p">);</span>

<span class="err">例</span><span class="mi">2</span> <span class="err">在其他关系中测试成员资格</span><span class="p">,</span><span class="err">只要是属性能对上就行</span><span class="p">.</span>
<span class="n">select</span> <span class="n">distinct</span><span class="p">(</span><span class="n">ID</span><span class="p">)</span>
<span class="n">from</span> <span class="n">takes</span>
<span class="n">where</span> <span class="p">(</span><span class="n">course_id</span><span class="p">,</span><span class="n">sec_id</span><span class="p">,</span><span class="n">semester</span><span class="p">,</span><span class="n">year</span><span class="p">)</span> <span class="n">in</span><span class="p">(</span><span class="n">select</span>                                                                          <span class="n">course_id</span><span class="p">,</span><span class="n">sec_id</span><span class="p">,</span><span class="n">semester</span><span class="p">,</span><span class="n">year</span>
                                          <span class="n">from</span> <span class="n">teaches</span>
                                          <span class="n">where</span> <span class="n">teaches</span><span class="p">.</span><span class="n">ID</span><span class="o">=</span><span class="mi">10010</span><span class="p">);</span>
<span class="p">)</span>
</pre></div>


<ul>
<li>from 嵌套子查询</li>
</ul>
<div class="highlight"><pre><span class="err">例</span><span class="mi">1</span> 
<span class="n">select</span> <span class="n">max</span> <span class="p">(</span><span class="n">total_salary</span><span class="p">)</span>
<span class="n">from</span> <span class="p">(</span><span class="n">select</span> <span class="n">dept_name</span><span class="p">,</span><span class="n">sum</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span>
        <span class="n">from</span> <span class="n">instructor</span>
        <span class="n">group</span> <span class="n">by</span> <span class="n">dept_name</span><span class="p">)</span> <span class="n">as</span> <span class="n">dept_total</span><span class="p">(</span><span class="n">dept_name</span><span class="p">,</span><span class="n">total_salary</span><span class="p">);</span>

<span class="err">例</span><span class="mi">2</span>
<span class="n">select</span> <span class="n">dept_name</span> <span class="n">avg_salary</span>
<span class="n">from</span> <span class="p">(</span><span class="n">select</span> <span class="n">dept_name</span> <span class="p">,</span><span class="n">avg</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span> <span class="n">as</span> <span class="n">avg_salary</span>
        <span class="n">from</span> <span class="n">instructor</span>
        <span class="n">group</span> <span class="n">by</span> <span class="n">dept_name</span><span class="p">)</span>
<span class="n">where</span> <span class="n">avg_salary</span> <span class="o">&gt;</span> <span class="mi">40000</span><span class="p">;</span>
</pre></div>


<h4>delete 元组</h4>
<div class="highlight"><pre><span class="n">delete</span> <span class="n">from</span> <span class="n">instructor</span>
<span class="n">where</span> <span class="n">salary</span> <span class="n">between</span> <span class="mi">10000</span> <span class="n">and</span> <span class="mi">20000</span><span class="p">;</span>

<span class="n">delete</span> <span class="n">from</span> <span class="n">instructor</span> 
<span class="n">where</span> <span class="n">dept_name</span> <span class="nf">in</span> <span class="p">(</span><span class="n">select</span> <span class="n">dept_name</span>
                    <span class="n">from</span> <span class="n">department</span> 
                    <span class="n">where</span> <span class="n">building</span> <span class="o">=</span><span class="err">&#39;</span><span class="n">Waston</span><span class="err">&#39;</span><span class="p">);</span>
</pre></div>


<h4>insert 元组</h4>
<p>这种方式适合忘记了表中属性顺序被忘记的情况。</p>
<div class="highlight"><pre><span class="n">insert</span> <span class="n">into</span> <span class="nf">course</span><span class="p">(</span><span class="n">course_id</span><span class="p">,</span><span class="n">title</span><span class="p">,</span><span class="n">dept_name</span><span class="p">,</span><span class="n">credits</span><span class="p">)</span>
    <span class="n">values</span><span class="p">(</span><span class="err">&#39;</span><span class="n">CS</span><span class="o">-</span><span class="mi">437</span><span class="sc">&#39;,&#39;</span><span class="n">DataBase</span> <span class="n">System</span><span class="sc">&#39;,&#39;</span><span class="n">Comp</span><span class="p">.</span><span class="n">Sci</span><span class="err">&#39;</span><span class="p">,</span><span class="mi">4</span><span class="p">);</span>
</pre></div>


<h4>集合的比较</h4>
<ul>
<li>some关键字:至少比某一个要大</li>
</ul>
<div class="highlight"><pre><span class="n">select</span> <span class="n">name</span> 
<span class="n">from</span> <span class="n">instructor</span>
<span class="n">where</span> <span class="n">salary</span><span class="o">&gt;</span><span class="n">some</span> <span class="p">(</span><span class="n">select</span> <span class="n">salary</span>
                    <span class="n">from</span> <span class="n">instructor</span>
                    <span class="n">where</span> <span class="n">dept_name</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">Biology</span><span class="err">&#39;</span><span class="p">);</span>
</pre></div>


<ul>
<li>all关键字：比所有的都大</li>
</ul>
<div class="highlight"><pre><span class="n">select</span> <span class="n">dept_name</span>
<span class="n">from</span> <span class="n">instructor</span>
<span class="n">group</span> <span class="n">by</span> <span class="n">dept_name</span>
<span class="n">having</span> <span class="nf">avg</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">all</span> <span class="p">(</span><span class="n">select</span> <span class="n">avg</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span>
                            <span class="n">from</span> <span class="n">instructor</span>
                            <span class="n">group</span> <span class="n">by</span> <span class="n">dept_name</span><span class="p">);</span>
</pre></div>


<h4>exists关键字</h4>
<div class="highlight"><pre><span class="n">select</span> <span class="n">course_id</span>
<span class="n">from</span> <span class="n">section</span> <span class="n">as</span> <span class="n">S</span>
<span class="n">where</span> <span class="n">semester</span> <span class="o">=</span><span class="err">&#39;</span><span class="n">Fall</span><span class="err">&#39;</span> <span class="n">and</span> <span class="n">year</span><span class="o">=</span><span class="mi">2009</span> <span class="n">and</span> 
    <span class="n">exists</span><span class="p">(</span><span class="n">select</span> <span class="o">*</span>
            <span class="n">from</span> <span class="n">section</span> <span class="n">as</span> <span class="n">T</span>
            <span class="n">where</span> <span class="n">semester</span><span class="o">=</span><span class="err">&#39;</span><span class="n">Spring</span><span class="err">&#39;</span> <span class="n">and</span> <span class="n">year</span><span class="o">=</span><span class="mi">2010</span> <span class="n">and</span> 
            <span class="n">S</span><span class="p">.</span><span class="n">course_id</span><span class="o">=</span><span class="n">T</span><span class="p">.</span><span class="n">course_id</span><span class="p">);</span>
</pre></div>


<p>这个例子也说明来自外层查询的一个相关名称可以用在where子句的子查询中.</p>
<h4>unique关键字</h4>
<p>如果作为参数的子查询结果中没有重复的元组,unique将返回true.</p>
<div class="highlight"><pre><span class="err">例</span><span class="mi">1</span> <span class="err">找出所有在</span><span class="mi">2009</span><span class="err">年最多开设一次的课程</span><span class="p">.</span><span class="err">如果某门课程不在</span><span class="mi">2009</span><span class="err">年开设</span><span class="p">,</span><span class="err">那么子查询会返回一个空的结果</span><span class="p">,</span><span class="n">unique</span><span class="err">谓词在空集上计算出真值</span><span class="p">.</span>

<span class="n">select</span> <span class="n">T</span><span class="p">.</span><span class="n">course_id</span>
<span class="n">from</span> <span class="n">course</span> <span class="n">as</span> <span class="n">T</span>
<span class="n">where</span> <span class="n">unique</span><span class="p">(</span>
            <span class="n">select</span> <span class="n">R</span><span class="p">.</span><span class="n">course_id</span>
            <span class="n">from</span> <span class="n">section</span> <span class="n">as</span> <span class="n">R</span>
            <span class="n">where</span> <span class="n">T</span><span class="p">.</span><span class="n">course_id</span><span class="o">=</span><span class="n">R</span><span class="p">.</span><span class="n">course_id</span> <span class="n">and</span> <span class="n">R</span><span class="p">.</span><span class="n">year</span><span class="o">=</span><span class="mi">2009</span><span class="p">);</span>

<span class="err">例</span><span class="mi">2</span> <span class="err">例</span><span class="mi">1</span><span class="err">的等价解法</span><span class="p">.</span>            
<span class="n">select</span> <span class="n">T</span><span class="p">.</span><span class="n">course_id</span>
<span class="n">from</span> <span class="n">course</span> <span class="n">as</span> <span class="n">T</span>
<span class="n">where</span> <span class="mi">1</span><span class="o">&gt;=</span><span class="p">(</span><span class="n">select</span> <span class="n">count</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="n">course_id</span><span class="p">)</span>
            <span class="n">from</span> <span class="n">section</span> <span class="n">as</span> <span class="n">R</span>
            <span class="n">where</span> <span class="n">T</span><span class="p">.</span><span class="n">course_id</span><span class="o">=</span><span class="n">R</span><span class="p">.</span><span class="n">course_id</span> <span class="n">and</span> <span class="n">R</span><span class="p">.</span><span class="n">year</span><span class="o">=</span><span class="mi">2009</span><span class="p">);</span>
</pre></div>


<h4>with子句</h4>
<p>定义临时关系，只对包含with子句的查询有效.</p>
<div class="highlight"><pre><span class="n">with</span> <span class="n">dept_total</span><span class="p">(</span><span class="n">dept_name</span><span class="p">,</span><span class="n">value</span><span class="p">)</span> <span class="n">as</span> <span class="c1">//定义两个关系dept_total,dept_total_avg</span>
    <span class="p">(</span><span class="n">select</span> <span class="n">dept_name</span><span class="p">,</span><span class="n">sum</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span>
    <span class="n">from</span> <span class="n">instructor</span>
    <span class="n">group</span> <span class="n">by</span> <span class="n">dept_name</span><span class="p">),</span>
    <span class="n">dept_total_avg</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="n">as</span>
    <span class="p">(</span><span class="n">select</span> <span class="n">avg</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="n">from</span> <span class="n">dept_total</span><span class="p">)</span>
<span class="n">select</span> <span class="n">dept_name</span>
<span class="n">from</span> <span class="n">dept_total</span><span class="p">,</span><span class="n">dept_total_avg</span>
<span class="n">where</span> <span class="n">dept_total</span><span class="p">.</span><span class="n">value</span><span class="o">&gt;=</span><span class="n">dept_total_avg</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
</pre></div>


<h4>insert</h4>
<p>在查询结果的基础上插入元组,即用select选出一个元组集合.insert和select执行的顺序很重要.先select出元组,再insert.</p>
<div class="highlight"><pre><span class="n">insert</span> <span class="n">into</span> <span class="n">instructor</span>
    <span class="n">select</span> <span class="n">ID</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">dept_name</span><span class="p">,</span><span class="mi">18000</span>
    <span class="n">from</span> <span class="n">student</span>
    <span class="n">where</span> <span class="n">dept_name</span><span class="o">=</span><span class="err">&#39;</span><span class="n">Music</span><span class="err">&#39;</span> <span class="n">and</span> <span class="n">tot_cred</span><span class="o">&gt;</span><span class="mi">144</span><span class="p">;</span>
</pre></div>


<h4>update 更新</h4>
<p>如果我们希望在不改变整个元组的情况下改变部分属性的值,可以使用update+set.</p>
<div class="highlight"><pre><span class="n">update</span> <span class="n">instructor</span>
<span class="n">set</span> <span class="n">salary</span><span class="o">=</span><span class="n">salary</span><span class="o">*</span><span class="mf">1.5</span>
<span class="n">where</span> <span class="n">salary</span><span class="o">&lt;</span><span class="p">(</span><span class="n">select</span> <span class="n">avg</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span>
                <span class="n">from</span> <span class="n">instructor</span><span class="p">);</span>
</pre></div>


<h4>case 关键字</h4>
<p>语法:</p>
<div class="highlight"><pre><span class="k">case</span> 
    <span class="n">when</span> <span class="n">pred1</span> <span class="n">then</span> <span class="n">result1</span>
    <span class="n">when</span> <span class="n">pred2</span> <span class="n">then</span> <span class="n">result2</span>
    <span class="p">...</span>
    <span class="k">else</span> <span class="n">result0</span>
<span class="n">end</span>
</pre></div>


<div class="highlight"><pre><span class="err">例</span><span class="mi">1</span>
<span class="n">update</span> <span class="n">instructor</span>
<span class="n">set</span> <span class="n">salary</span> <span class="o">=</span> <span class="k">case</span>
                <span class="n">when</span> <span class="n">salary</span><span class="o">&lt;=</span><span class="mi">100000</span> <span class="n">then</span> <span class="n">salary</span><span class="o">*</span><span class="mf">1.05</span>
                <span class="k">else</span> <span class="n">salay</span><span class="o">*</span><span class="mf">1.03</span>
            <span class="n">end</span>
</pre></div>
                </div><!-- /.entry-content -->
                <div class="comments">
                <h2>Comments !</h2>
                        <div id="disqus_thread"></div>
                        <script type="text/javascript">
                           var disqus_identifier = "SQL学习笔记.html";
                           (function() {
                                var dsq = document.createElement('script');
                                dsq.type = 'text/javascript'; dsq.async = true;
                                dsq.src = 'http://buptlixin.disqus.com/embed.js';
                                (document.getElementsByTagName('head')[0] ||
                                 document.getElementsByTagName('body')[0]).appendChild(dsq);
                          })();
                        </script>
                </div>
        </article>
</section>
        </div><!--/span-->

                <div class="span3 well sidebar-nav" id="sidebar">
<ul class="nav nav-list">
<li class="nav-header"><h4><i class="icon-external-link"></i>blogroll</h4></li>
    <li><a href="http://getpelican.com/"><i class="icon-external-link"></i>Pelican</a></li>
    <li><a href="http://python.org/"><i class="icon-external-link"></i>Python.org</a></li>
    <li><a href="http://jinja.pocoo.org/"><i class="icon-external-link"></i>Jinja2</a></li>
<li class="nav-header"><h4><i class="icon-home icon-large"></i> social</h4></li>
<li><a href="/" rel="alternate"><i class="icon-bookmark icon-large"></i>atom feed</a></li>
    <li><a href="http://www.v2ex.com/member/buptlee"><i class="icon-V2EX-sign icon-large"></i>V2EX</a></li>
    <li><a href="http://douban.com/people/77726008"><i class="icon-豆瓣-sign icon-large"></i>豆瓣</a></li>
    <li><a href="http://github.com/Xiaoxin2009"><i class="icon-Github-sign icon-large"></i>Github</a></li>
    <li><a href="http://stackoverflow.com/users/3373388/bupt-xiaoxin"><i class="icon-Stackoverflow-sign icon-large"></i>Stackoverflow</a></li>

<li class="nav-header"><h4><i class="icon-folder-close icon-large"></i>Categories</h4></li>
<li>
<a href="/category/fen-bu-shi.html">
    <i class="icon-folder-open icon-large"></i>分布式
</a>
</li>
<li>
<a href="/category/java.html">
    <i class="icon-folder-open icon-large"></i>JAVA
</a>
</li>
<li>
<a href="/category/machine-learning.html">
    <i class="icon-folder-open icon-large"></i>Machine Learning
</a>
</li>
<li>
<a href="/category/perl.html">
    <i class="icon-folder-open icon-large"></i>Perl
</a>
</li>
<li>
<a href="/category/python.html">
    <i class="icon-folder-open icon-large"></i>Python
</a>
</li>
<li>
<a href="/category/scala.html">
    <i class="icon-folder-open icon-large"></i>Scala
</a>
</li>
<li>
<a href="/category/shu-ju-ku.html">
    <i class="icon-folder-open icon-large"></i>数据库
</a>
</li>
<li>
<a href="/category/technology.html">
    <i class="icon-folder-open icon-large"></i>Technology
</a>
</li>

<li class="nav-header"><h4><i class="icon-tags icon-large"></i>Tags</h4></li>
<li class="tag-3">
    <a href="/tag/storm.html">
        <i class="icon-tag icon-large"></i>Storm
    </a>
</li>
<li class="tag-3">
    <a href="/tag/zheng-ze-biao-da-shi.html">
        <i class="icon-tag icon-large"></i>正则表达式
    </a>
</li>
<li class="tag-4">
    <a href="/tag/machine-learning.html">
        <i class="icon-tag icon-large"></i>Machine Learning
    </a>
</li>
<li class="tag-4">
    <a href="/tag/hadoop.html">
        <i class="icon-tag icon-large"></i>Hadoop
    </a>
</li>
<li class="tag-1">
    <a href="/tag/perl.html">
        <i class="icon-tag icon-large"></i>Perl
    </a>
</li>
<li class="tag-1">
    <a href="/tag/scala.html">
        <i class="icon-tag icon-large"></i>scala
    </a>
</li>
<li class="tag-4">
    <a href="/tag/functional-programming.html">
        <i class="icon-tag icon-large"></i>functional programming
    </a>
</li>
<li class="tag-4">
    <a href="/tag/svm.html">
        <i class="icon-tag icon-large"></i>SVM
    </a>
</li>
<li class="tag-4">
    <a href="/tag/mongodb.html">
        <i class="icon-tag icon-large"></i>MongoDB
    </a>
</li>
<li class="tag-4">
    <a href="/tag/hash.html">
        <i class="icon-tag icon-large"></i>Hash
    </a>
</li>
<li class="tag-3">
    <a href="/tag/sql.html">
        <i class="icon-tag icon-large"></i>SQL
    </a>
</li>
<li class="tag-4">
    <a href="/tag/github.html">
        <i class="icon-tag icon-large"></i>Github
    </a>
</li>
<li class="tag-4">
    <a href="/tag/hdfs.html">
        <i class="icon-tag icon-large"></i>HDFS
    </a>
</li>
<li class="tag-4">
    <a href="/tag/python.html">
        <i class="icon-tag icon-large"></i>Python
    </a>
</li>
<li class="tag-4">
    <a href="/tag/nosql.html">
        <i class="icon-tag icon-large"></i>NoSQL
    </a>
</li>
<li class="tag-4">
    <a href="/tag/functional-programing.html">
        <i class="icon-tag icon-large"></i>functional programing
    </a>
</li>
<li class="tag-1">
    <a href="/tag/java.html">
        <i class="icon-tag icon-large"></i>java
    </a>
</li>


</ul>        </div><!--/.well -->

      </div><!--/row-->

      <hr>

      <footer>
        <address id="about">
                Proudly powered by <a href="http://pelican.notmyidea.org/">Pelican <i class="icon-external-link"></i></a>,
                                which takes great advantage of <a href="http://python.org">Python <i class="icon-external-link"></i></a>.
        </address><!-- /#about -->

        <p>The theme is from <a href="http://twitter.github.com/bootstrap/">Bootstrap from Twitter <i class="icon-external-link"></i></a>,
                   and <a href="http://fortawesome.github.com/Font-Awesome/">Font-Awesome <i class="icon-external-link"></i></a>, thanks!</p>
      </footer>

    </div><!--/.fluid-container-->


<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
	var pageTracker = _gat._getTracker("UA-50849437-1");
pageTracker._trackPageview();
} catch(err) {}</script>
<script type="text/javascript">
    var disqus_shortname = 'buptlixin';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>

    <!-- Le javascript -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="/theme/js/jquery-1.7.2.min.js"></script>
    <script src="/theme/js/bootstrap.min.js"></script>
  </body>
</html>